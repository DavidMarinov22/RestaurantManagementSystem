{% extends 'base.html' %}

{% block content %}
<!DOCTYPE html>
<html>

<head>
    <title>User Accounts</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            color: #fff;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <h1>User Accounts</h1>

    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        Add New Staff
    </button>

    <table class="table" id="usersTable">
        <thead>
            <tr>
                {% for field in fields %}
                <th>{{ field }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr id="userRow-{{ user.id }}">
                <td>{{ user.id }}</td>
                <td>{{ user.first_name }}</td>
                <td>{{ user.last_name }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td class="{% if user.is_active %}text-success{% else %}text-danger{% endif %}">
                    {% if user.is_active %}
                    Employed
                    {% else %}
                    Unemployed
                    {% endif %}
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-warning edit-user" data-user-id="{{ user.id }}">
                        Edit
                    </button>
                    <button type="button" class="btn btn-sm btn-danger delete-user" data-user-id="{{ user.id }}">
                        Delete
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Staff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addUserForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" name="first_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" name="last_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" name="password2" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" name="is_active" id="is_active_new" checked>
                            <label class="form-check-label" for="is_active_new">Employed</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal (Dynamic content will be loaded here) -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="editUserId">
                    <div class="modal-body" id="editUserModalBody">
                        <!-- Content will be loaded via AJAX -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this user?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">

    <script>
        $(document).ready(function () {
            // Initialize toastr
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right"
            };

            // Add User Form Submission
            $('#addUserForm').on('submit', function (e) {
                e.preventDefault();
                $.ajax({
                    url: '{% url "staff:user_create" %}',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            // Add new row to table
                            const user = response.user;
                            const newRow = `
                            <tr id="userRow-${user.id}">
                                <td>${user.id}</td>
                                <td>${user.first_name || ''}</td>
                                <td>${user.last_name || ''}</td>
                                <td>${user.username}</td>
                                <td>${user.email || ''}</td>
                                <td class="${user.is_active ? 'text-success' : 'text-danger'}">
                                    ${user.is_active ? 'Employed' : 'Unemployed'}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-warning edit-user" data-user-id="${user.id}">
                                        Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger delete-user" data-user-id="${user.id}">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                            $('#usersTable tbody').append(newRow);
                            $('#addUserModal').modal('hide');
                            $('#addUserForm')[0].reset();
                            toastr.success('User added successfully');
                        } else {
                            toastr.error(response.error || 'Error adding user');
                        }
                    },
                    error: function (xhr) {
                        toastr.error('Error adding user');
                    }
                });
            });


            // Edit User Click button
            $(document).on('click', '.edit-user', function () {
                const userId = $(this).data('user-id');
                $('#editUserId').val(userId);

                // Load user data into modal
                $.ajax({
                    url: "{% url 'staff:user_update_form' 0 %}".replace('0', userId),
                    type: 'GET',
                    success: function (response) {
                        $('#editUserModalBody').html(response.form_html);  // Note the .form_html access
                        $('#editUserModal').modal('show');

                        // Initialize Select2 for groups
                        $('.groups-select').select2({
                            placeholder: "Select groups",
                            allowClear: true,
                            width: '100%'
                        });
                    },
                    error: function () {
                        toastr.error('Error loading user data');
                    }
                });
            });

            // Edit User Form Submission
            $('#editUserForm').on('submit', function (e) {
                e.preventDefault();
                const userId = $('#editUserId').val();
                const formData = $(this).serializeArray();

                // Convert form data to object
                let data = {};
                $.each(formData, function (index, field) {
                    data[field.name] = field.value;
                });

                // Handle groups separately
                data['groups'] = $('.groups-select').val();
                let groups = $('.groups-select').select2('data').map(item => item.id);
                formData.push({name: 'groups[]', value: groups});

                $.ajax({
                    url: "{% url 'staff:user_update' 0 %}".replace('0', userId),
                    type: 'POST',
                    data: data,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.success) {
                            // Update the row in the table
                            const user = response.user;
                            $(`#userRow-${user.id}`).html(`
                            <td>${user.id}</td>
                            <td>${user.first_name || ''}</td>
                            <td>${user.last_name || ''}</td>
                            <td>${user.username}</td>
                            <td>${user.email || ''}</td>
                            <td class="${user.is_active ? 'text-success' : 'text-danger'}">
                                ${user.is_active ? 'Employed' : 'Unemployed'}
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-warning edit-user" data-user-id="${user.id}">
                                    Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-danger delete-user" data-user-id="${user.id}">
                                    Delete
                                </button>
                            </td>
                        `);
                            $('#editUserModal').modal('hide');
                            toastr.success('User updated successfully');
                        } else {
                            toastr.error(response.error || 'Error updating user');
                        }
                    },

                    error: function (xhr) {
                        toastr.error('Error updating user: ' + xhr.responseText);
                    }
                });
            });



            // Delete User Button Click
            $(document).on('click', '.delete-user', function () {
                const userId = $(this).data('user-id');
                $('#deleteUserModal').data('user-id', userId).modal('show');
            });

            // Confirm Delete
            $('#confirmDelete').on('click', function () {
                const userId = $('#deleteUserModal').data('user-id');

                $.ajax({
                    url: "{% url 'staff:user_delete' 0 %}".replace('0', userId),
                    type: 'POST',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.success) {
                            $(`#userRow-${userId}`).remove();
                            $('#deleteUserModal').modal('hide');
                            toastr.success('User deleted successfully');
                        } else {
                            toastr.error(response.error || 'Error deleting user');
                        }
                    },
                    error: function () {
                        toastr.error('Error deleting user');
                    }
                });
            });

            // Handle group changes
            $(document).on('change', '.groups-select', function () {
                const userId = $(this).data('user-id');
                const groupIds = $(this).val();

                $.ajax({
                    url: '{% url "staff:update_user_groups" %}',
                    method: 'POST',
                    data: {
                        'user_id': userId,
                        'group_ids': groupIds,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        toastr.success('Groups updated successfully');
                    },
                    error: function (xhr) {
                        toastr.error('Error updating groups');
                    }
                });
            });
        });
    </script>
</body>

</html>
{% endblock %}